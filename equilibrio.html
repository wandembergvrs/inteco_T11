<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oferta × Demanda — Quantidade escolhida, CS/PS e setas</title>
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--axis:#9ca3af;--grid:#1f2937;
      --d:#93c5fd;--s:#86efac;--cs:rgba(99,102,241,.30);--ps:rgba(34,197,94,.30);
      --neg:rgba(244,63,94,.25);--barcs:#6366f1;--barps:#22c55e
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#0f172a;color:var(--text);min-height:100vh;display:grid;grid-template-rows:auto 1fr}
    header{padding:16px 20px;border-bottom:1px solid #0b1020}
    header h1{margin:0;font-size:20px}
    header .sub{color:var(--muted);font-size:12px}
    main{display:grid;grid-template-columns:400px 1fr;gap:16px;padding:16px}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 70px;gap:10px;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input[type=range]{width:100%}
    .val{font-variant-numeric:tabular-nums;text-align:right;font-size:13px}
    .buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    button{cursor:pointer;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;padding:9px 10px;border-radius:10px;font-weight:600;font-size:12px}
    button:hover{border-color:#334155}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px}
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-variant-numeric:tabular-nums;font-weight:800;font-size:18px}
    canvas{width:100%;height:100%;display:block;background:#0b1220;border-radius:14px}
    .barsLegend{display:flex;gap:14px;align-items:center;justify-content:center;margin-top:6px;color:#cbd5e1;font-size:12px}
    .legendDot{width:10px;height:10px;border-radius:2px;display:inline-block}
    .legendDot.cs{background:rgba(99,102,241,.55);border:1px solid #6366f1}
    .legendDot.ps{background:rgba(34,197,94,.55);border:1px solid #22c55e}
    @media (max-width:980px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Curvas fixas + quantidade escolhida</h1>
    <div class="sub">Escolha Q abaixo/acima do equilíbrio. Barras mostram CS/PS (3 casas), setas ↑/↓ indicam variação ao mover Q. P* fixo.</div>
  </header>

  <main>
    <section class="panel" aria-label="Controles">
      <div class="row"><div><label for="a">Demanda: intercepto (a) — P = a − b·Q</label><input id="a" type="range" min="5" max="15" step="0.1" value="9.5"></div><div class="val" id="aval">9.5</div></div>
      <div class="row"><div><label for="b">Demanda: inclinação (b)</label><input id="b" type="range" min="0.2" max="2.0" step="0.1" value="1.0"></div><div class="val" id="bval">1.0</div></div>
      <div class="row"><div><label for="c">Oferta: intercepto (c) — P = c + d·Q</label><input id="c" type="range" min="0" max="5" step="0.1" value="1.0"></div><div class="val" id="cval">1.0</div></div>
      <div class="row"><div><label for="d">Oferta: inclinação (d)</label><input id="d" type="range" min="0.2" max="2.0" step="0.1" value="0.8"></div><div class="val" id="dval">0.8</div></div>

      <div class="row"><div><label for="q">Quantidade escolhida (Q)</label><input id="q" type="range" min="0" max="12" step="0.01" value="4.00"></div><div class="val" id="qval">4.00</div></div>

      <div class="buttons">
        <button id="qLess">Q &lt; Q*</button>
        <button id="qEq">Q = Q*</button>
        <button id="qMore">Q &gt; Q*</button>
      </div>

      <div class="metrics" aria-live="polite">
        <div class="metric"><div class="k">Equilíbrio (Q*, P*)</div><div class="v" id="eq">—</div></div>
        <div class="metric"><div class="k">CS(Q)</div><div class="v" id="csVal">—</div></div>
        <div class="metric"><div class="k">PS(Q)</div><div class="v" id="psVal">—</div></div>
      </div>
    </section>

    <section class="panel">
      <canvas id="chart" width="980" height="600" aria-label="Plano P×Q"></canvas>
      <div class="barsLegend">
        <span><span class="legendDot cs"></span> Excedente do Consumidor (CS)</span>
        <span><span class="legendDot ps"></span> Excedente do Produtor (PS)</span>
      </div>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    const a=$("a"), b=$("b"), c=$("c"), d=$("d"), q=$("q");
    const aval=$("aval"), bval=$("bval"), cval=$("cval"), dval=$("dval"), qval=$("qval"), eqEl=$("eq"), csEl=$("csVal"), psEl=$("psVal");

    const canvas=$("chart"); const ctx=canvas.getContext('2d');
    const pad={left:70,right:20,top:24,bottom:60}; let Qmax=12, Pmax=12;

    // estado para setas/variação nas barras
    let lastCS=null, lastPS=null, lastQ=null;

    function toPX(x,y){ const W=canvas.width-pad.left-pad.right-140; const H=canvas.height-pad.top-pad.bottom; return [pad.left+(x/Qmax)*W, pad.top+H-(y/Pmax)*H]; }
    function line(x1,y1,x2,y2,clr,width=2){ ctx.beginPath(); const [x1p,y1p]=toPX(x1,y1); const [x2p,y2p]=toPX(x2,y2); ctx.moveTo(x1p,y1p); ctx.lineTo(x2p,y2p); ctx.lineWidth=width; ctx.strokeStyle=clr; ctx.stroke(); }
    function poly(pts,fill,stroke,width=1){ if(!pts.length)return; ctx.beginPath(); const [x0,y0]=toPX(pts[0][0],pts[0][1]); ctx.moveTo(x0,y0); for(let i=1;i<pts.length;i++){const [x,y]=toPX(pts[i][0],pts[i][1]); ctx.lineTo(x,y);} ctx.closePath(); if(fill){ctx.fillStyle=fill; ctx.fill();} if(stroke){ctx.lineWidth=width; ctx.strokeStyle=stroke; ctx.stroke();} }

    function eq(A,B,C,D){ const denom=B+D; if(denom<=0) return {ok:false}; const Q=(A-C)/denom; const P=A-B*Q; if(!isFinite(Q)||!isFinite(P)||Q<=0||P<=0) return {ok:false}; return {ok:true,Q,P}; }

    function draw(){
      const A=parseFloat(a.value), B=parseFloat(b.value), C=parseFloat(c.value), D=parseFloat(d.value); let Q=parseFloat(q.value);
      aval.textContent=A.toFixed(1); bval.textContent=B.toFixed(1); cval.textContent=C.toFixed(1); dval.textContent=D.toFixed(1); qval.textContent=Q.toFixed(2);

      // limites (curvas fixas — variar Q não move curvas)
      const qIntD = Math.max(6, Math.min(40, A/Math.max(0.2,B)));
      const qIntS = (C<0)? Math.max(6, Math.min(40, (-C)/Math.max(0.2,D))) : 12;
      Qmax = Math.max(8, Math.ceil(Math.max(qIntD,qIntS)/2)*2);
      Pmax = Math.max(8, Math.ceil(Math.max(A, C + D*Qmax)/2)*2);
      q.max = Qmax.toString();

      ctx.clearRect(0,0,canvas.width,canvas.height);
      // grid
      for(let x=0;x<=Qmax;x+=1){ line(x,0,x,Pmax,getComputedStyle(document.documentElement).getPropertyValue('--grid'),1); }
      for(let y=0;y<=Pmax;y+=1){ line(0,y,Qmax,y,getComputedStyle(document.documentElement).getPropertyValue('--grid'),1); }
      // axes
      line(0,0,Qmax,0,getComputedStyle(document.documentElement).getPropertyValue('--axis'),2.5);
      line(0,0,0,Pmax,getComputedStyle(document.documentElement).getPropertyValue('--axis'),2.5);
      // labels
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text'); ctx.font='12px ui-sans-serif'; ctx.textAlign='center';
      for(let x=0;x<=Qmax;x+=1){ const [px,py]=toPX(x,0); ctx.fillText(x.toString(),px,py+16); }
      ctx.save(); ctx.textAlign='right'; for(let y=0;y<=Pmax;y+=1){ const [px,py]=toPX(0,y); ctx.fillText(y.toString(),px-8,py+4); } ctx.restore();
      const W=canvas.width-pad.left-pad.right-140, H=canvas.height-pad.top-pad.bottom; ctx.fillText('Quantidade (Q)', pad.left+W/2, pad.top+H+38); ctx.save(); ctx.translate(18,pad.top+H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Preço (P)',0,0); ctx.restore();

      // curvas FIXAS
      line(0,A,Qmax, A-B*Qmax, '#a5b4fc',3); // demanda
      line(0,C,Qmax, C+D*Qmax, '#86efac',3); // oferta

      const base = eq(A,B,C,D);
      if(!base.ok){ eqEl.textContent='—'; csEl.textContent='—'; psEl.textContent='—'; return; }
      eqEl.textContent = `${base.Q.toFixed(2)}, ${base.P.toFixed(2)}`;

      // preço de referência FIXO P*
      line(0, base.P, Qmax, base.P, '#94a3b8',1.6);

      // ponto E*
      const [ex,ey]=toPX(base.Q, base.P); ctx.beginPath(); ctx.arc(ex,ey,4,0,2*Math.PI); ctx.fillStyle='#fde68a'; ctx.fill();
      // guia vertical em Q*
      line(base.Q, 0, base.Q, base.P, '#94a3b8',1.2);

      // posição escolhida Q e seta no eixo em direção a Q*
      line(Q, 0, Q, Pmax, '#64748b', 1.2);
      const [qx, qy] = toPX(Q, 0), [qstx,_]=toPX(base.Q,0);
      ctx.beginPath(); ctx.moveTo(qx, qy+8); ctx.lineTo(qstx, qy+8); ctx.lineWidth=2; const dirCol = Q<base.Q ? '#22c55e' : (Q>base.Q ? '#f43f5e' : '#94a3b8'); ctx.strokeStyle = dirCol; ctx.stroke();
      ctx.beginPath(); ctx.moveTo(qstx, qy+8); ctx.lineTo(qstx-6, qy+4); ctx.lineTo(qstx-6, qy+12); ctx.closePath(); ctx.fillStyle = dirCol; ctx.fill();

      // CS(Q) e PS(Q) ao preço P*
      const Pd = (qq)=> A - B*qq; const Ps = (qq)=> C + D*qq;
      const CS = (A*Q - 0.5*B*Q*Q) - base.P*Q;
      const PS = base.P*Q - (C*Q + 0.5*D*Q*Q);
      csEl.textContent = CS.toFixed(3); psEl.textContent = PS.toFixed(3);

      // sombrear positivos até min(Q,Q*)
      const Qpos = Math.min(Q, base.Q);
      if (Qpos > 0){
        poly([[0,base.P],[0,Math.min(Pmax,A)],[Qpos, Pd(Qpos)],[Qpos, base.P]], 'var(--cs)', '#6366f1', 1.2);
        poly([[0,Math.max(0,C)],[Qpos, Ps(Qpos)],[Qpos, base.P],[0, base.P]], 'var(--ps)', '#22c55e', 1.2);
      }
      // perdas marginais se Q>Q*
      if (Q > base.Q){
        const Qa = base.Q, Qb = Math.min(Q, Qmax);
        poly([[Qa, base.P],[Qa, Pd(Qa)],[Qb, Pd(Qb)],[Qb, base.P]], 'var(--neg)', '#f43f5e', 1);
        poly([[Qa, Ps(Qa)],[Qa, base.P],[Qb, base.P],[Qb, Ps(Qb)]], 'var(--neg)', '#f43f5e', 1);
      }

      // Barras CS/PS e deltas (3 casas)
      const barArea = { x: canvas.width - 120, y: pad.top + 10, w: 100, h: canvas.height - pad.top - pad.bottom - 20 };
      ctx.save(); ctx.strokeStyle = '#374151'; ctx.lineWidth = 1; ctx.strokeRect(barArea.x, barArea.y, barArea.w, barArea.h);
      ctx.fillStyle = '#94a3b8'; ctx.font = '12px ui-sans-serif'; ctx.fillText('Excedentes', barArea.x + 10, barArea.y - 6);
      const CSstar = (A*base.Q - 0.5*B*base.Q*base.Q) - base.P*base.Q;
      const PSstar = base.P*base.Q - (C*base.Q + 0.5*D*base.Q*base.Q);
      const csShow = Math.max(0, CS), psShow = Math.max(0, PS), csStar = Math.max(0, CSstar), psStar = Math.max(0, PSstar);
      const maxVal = Math.max(1, csShow, psShow, csStar, psStar);
      const scale = (barArea.h - 30) / maxVal; const barW = 26; const gap = 16; const baseY = barArea.y + barArea.h - 10;
      function bar(x,val,fill,stroke,label){ const h=Math.max(0,val)*scale; ctx.fillStyle=fill; ctx.fillRect(x, baseY-h, barW, h); ctx.strokeStyle=stroke; ctx.lineWidth=1.5; ctx.strokeRect(x, baseY-h, barW, h); ctx.fillStyle='#cbd5e1'; ctx.font='11px ui-sans-serif'; ctx.fillText(label, x+4, baseY+14); ctx.fillText(val.toFixed(3), x-4, baseY-h-6); return {x, yTop: baseY-h, h}; }
      function ghost(x,val){ const h=Math.max(0,val)*scale; ctx.save(); ctx.setLineDash([3,3]); ctx.strokeStyle='rgba(148,163,184,0.8)'; ctx.strokeRect(x, baseY-h, barW, h); ctx.restore(); }
      const xCS = barArea.x + 10, xPS = xCS + barW + gap; const csBar = bar(xCS, csShow, 'rgba(99,102,241,0.55)', 'var(--barcs)', 'CS'); const psBar = bar(xPS, psShow, 'rgba(34,197,94,0.55)', 'var(--barps)', 'PS'); ghost(xCS, csStar); ghost(xPS, psStar);

      // setas de variação (comparando com o último Q)
      function deltaArrow(xCenter, yTop, delta){ if (delta===null) return; const up = delta>0; const y = up ? yTop - 16 : yTop + 16; ctx.beginPath(); if (up){ ctx.moveTo(xCenter, y); ctx.lineTo(xCenter, yTop-4); ctx.strokeStyle = '#86efac'; ctx.lineWidth=2; ctx.stroke(); ctx.beginPath(); ctx.moveTo(xCenter, yTop-4); ctx.lineTo(xCenter-5, yTop+3); ctx.lineTo(xCenter+5, yTop+3); ctx.closePath(); ctx.fillStyle='#86efac'; ctx.fill(); } else { ctx.moveTo(xCenter, yTop+4); ctx.lineTo(xCenter, y); ctx.strokeStyle = '#fca5a5'; ctx.lineWidth=2; ctx.stroke(); ctx.beginPath(); ctx.moveTo(xCenter, yTop+4); ctx.lineTo(xCenter-5, yTop-3); ctx.lineTo(xCenter+5, yTop-3); ctx.closePath(); ctx.fillStyle='#fca5a5'; ctx.fill(); } ctx.fillStyle = up ? '#86efac' : '#fca5a5'; ctx.font = '11px ui-sans-serif'; const txt = (delta>0?'+':'') + delta.toFixed(3); ctx.fillText(txt, xCenter - 16, up ? (y-4) : (y+12)); }
      const dCS = (lastCS===null || lastQ===null) ? null : (csShow - lastCS); const dPS = (lastPS===null || lastQ===null) ? null : (psShow - lastPS); deltaArrow(csBar.x + barW/2, csBar.yTop, dCS); deltaArrow(psBar.x + barW/2, psBar.yTop, dPS);
      ctx.restore();

      lastCS = csShow; lastPS = psShow; lastQ = Q;
    }

    [a,b,c,d,q].forEach(inp=>inp.addEventListener('input', draw));
    $("qLess").addEventListener('click', ()=>{ const A=parseFloat(a.value),B=parseFloat(b.value),C=parseFloat(c.value),D=parseFloat(d.value); const Qs=(A-C)/(B+D); q.value = Math.max(0, Qs-2).toFixed(2); draw(); });
    $("qEq").addEventListener('click', ()=>{ const A=parseFloat(a.value),B=parseFloat(b.value),C=parseFloat(c.value),D=parseFloat(d.value); const Qs=(A-C)/(B+D); q.value = Math.max(0, Math.min(Qmax, Qs)).toFixed(2); draw(); });
    $("qMore").addEventListener('click', ()=>{ const A=parseFloat(a.value),B=parseFloat(b.value),C=parseFloat(c.value),D=parseFloat(d.value); const Qs=(A-C)/(B+D); q.value = Math.min(Qmax, Qs+2).toFixed(2); draw(); });

    function resize(){ const rect=canvas.getBoundingClientRect(); const scale=window.devicePixelRatio||1; canvas.width=Math.max(760, Math.floor(rect.width*scale)); canvas.height=Math.max(520, Math.floor(rect.width*0.6*scale)); draw(); }
    new ResizeObserver(resize).observe(canvas); window.addEventListener('load', resize);
  </script>
</body>
</html>
