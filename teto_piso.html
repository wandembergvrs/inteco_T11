<!DOCTYPE html>


 // auto limites
 const qIntD = Math.max(6, Math.min(40, A/Math.max(0.2,B)));
 const qIntS = (C<0)? Math.max(6, Math.min(40, (-C)/Math.max(0.2,D))) : 12;
 Qmax = Math.max(8, Math.ceil(Math.max(qIntD,qIntS)/2)*2);
 Pmax = Math.max(8, Math.ceil(Math.max(A, C + D*Qmax, PC)*2)/2);
 pc.max = Pmax.toFixed(0);


 ctx.clearRect(0,0,canvas.width,canvas.height);
 // grid & axes
 for(let x=0;x<=Qmax;x++){ line(x,0,x,Pmax,'#1f2937',1); }
 for(let y=0;y<=Pmax;y++){ line(0,y,Qmax,y,'#1f2937',1); }
 line(0,0,Qmax,0,'#9ca3af',2.2); line(0,0,0,Pmax,'#9ca3af',2.2);
 // ticks
 ctx.fillStyle='#e5e7eb'; ctx.font='12px ui-sans-serif'; ctx.textAlign='center';
 for(let x=0;x<=Qmax;x++){ const [px,py]=toPX(x,0); ctx.fillText(x.toString(),px,py+16); }
 ctx.save(); ctx.textAlign='right'; for(let y=0;y<=Pmax;y++){ const [px,py]=toPX(0,y); ctx.fillText(y.toString(),px-8,py+4); } ctx.restore();
 // axis labels
 const W=canvas.width-pad.left-pad.right, H=canvas.height-pad.top-pad.bottom; ctx.textAlign='center'; ctx.fillText('Quantidade (Q)', pad.left+W/2, pad.top+H+38); ctx.save(); ctx.translate(18,pad.top+H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Preço (P)',0,0); ctx.restore();


 // curvas
 line(0,A,Qmax, A-B*Qmax, '#a5b4fc',3); // demanda
 line(0,C,Qmax, C+D*Qmax, '#86efac',3); // oferta


 // equilíbrio
 const E = eq(A,B,C,D); eqEl.textContent = `Q*=${E.Q.toFixed(2)}, P*=${E.P.toFixed(2)}`;
 // ponto
 const [ex,ey]=toPX(E.Q,E.P); ctx.beginPath(); ctx.arc(ex,ey,4,0,2*Math.PI); ctx.fillStyle=varColor('--eq','#fde68a'); ctx.fill();


 // preço regulado
 line(0,PC,Qmax,PC, varColor('--ctl','#fb923c'), 2.4);


 // Quantidades a esse preço
 const Qd = Math.max(0, Math.min(Qmax, invD(A,B,PC)));
 const Qs = Math.max(0, Math.min(Qmax, invS(C,D,PC)));
 qvals.textContent = `Qd=${Qd.toFixed(2)}, Qs=${Qs.toFixed(2)}`;


 // Situação
 let situacao = 'Não vinculante'; let mag = 0; let color=null;
 if(mode.value==='teto'){
 if(PC < E.P){ situacao = 'TETO VINCULANTE → ESCASSEZ'; mag = Math.max(0, Qd - Qs); color='shortage'; }
 else { situacao = 'TETO NÃO vinculante (mercado em P*)'; }
 } else { // piso
 if(PC > E.P){ situacao = 'PISO VINCULANTE → EXCESSO'; mag = Math.max(0, Qs - Qd); color='surplus'; }
 else { situacao = 'PISO NÃO vinculante (mercado em P*)'; }
 }
 statusEl.textContent = situacao; magEl.textContent = color? `${mag.toFixed(2)} unidades` : '—';


 // Desenhar Qd e Qs no preço
 // Qd: interseção com demanda
 let [qdX,qdY] = toPX(Qd, PC); let [qsX,qsY] = toPX(Qs, PC);
 // linhas verticais
 line(Qd,0,Qd,PC,'#60a5fa',1.4); line(Qs,0,Qs,PC,'#22c55e',1.4);
 // marcadores
 drawTick(Qd,PC,'Qd'); drawTick(Qs,PC,'Qs');


 // Faixa de escassez/excesso ao longo do preço
 if(color==='shortage' && Qd>Qs){ box(Qs, PC, Qd, PC, varColor('--shortage','rgba(244,63,94,.30)'),'#f43f5e'); }
 if(color==='surplus' && Qs>Qd){ box(Qd, PC, Qs, PC, varColor('--surplus','rgba(59,130,246,.30)'),'#3b82f6'); }


 // explicação
 explain.innerHTML = buildExplain(mode.value, PC, E.P, Qd, Qs);
 }


 function varColor(v, fallback){ const s=getComputedStyle(document.documentElement).getPropertyValue(v); return s && s.trim()? s.trim(): fallback; }
 function drawTick(Q,P,label){ const [x,y]=toPX(Q,P); ctx.fillStyle='#cbd5e1'; ctx.font='11px ui-sans-serif'; ctx.textAlign='center'; ctx.fillText(`${label}=${Q.toFixed(2)}`, x, y-6); }
 function box(q1,p1,q2,p2,fill,stroke){ const [x0,y0]=toPX(q1,p1); const [x1,y1]=toPX(q2,p2); ctx.fillStyle=fill; ctx.fillRect(x0, y1, x1-x0, y0-y1); ctx.strokeStyle=stroke; ctx.lineWidth=1.4; ctx.strokeRect(x0, y1, x1-x0, y0-y1); }


 function buildExplain(mode, PC, Pe, Qd, Qs){
 const f = (x)=> x.toFixed(2);
 if(mode==='teto'){
 if(PC < Pe) return `Como <b>teto</b> com P<sub>c</sub>=${f(PC)} < Pe*=${f(Pe)}, o preço não pode subir até P*. A ${f(PC)} temos <b>Qd=${f(Qd)}</b> e <b>Qs=${f(Qs)}</b>, gerando <b>escassez</b> de ${f(Qd-Qs)}.`;
 return `Teto em ${f(PC)} ≥ P*=${f(Pe)} é <b>não vinculante</b>: o mercado opera no equilíbrio.`;
 } else {
 if(PC > Pe) return `Como <b>piso</b> com P<sub>c</sub>=${f(PC)} > Pe*=${f(Pe)}, o preço não pode cair até P*. A ${f(PC)} temos <b>Qd=${f(Qd)}</b> e <b>Qs=${f(Qs)}</b>, gerando <b>excesso</b> de ${f(Qs-Qd)}.`;
 return `Piso em ${f(PC)} ≤ P*=${f(Pe)} é <b>não vinculante</b>: o mercado opera no equilíbrio.`;
 }
 }


 function resize(){ const rect=canvas.getBoundingClientRect(); const scale=window.devicePixelRatio||1; canvas.width=Math.max(760, Math.floor(rect.width*scale)); canvas.height=Math.max(520, Math.floor(rect.width*0.6*scale)); draw(); }
 new ResizeObserver(resize).observe(canvas);


 [mode,a,b,c,d,pc].forEach(el=> el.addEventListener('input', draw));
 window.addEventListener('load', resize);
 </script>
</body>
</html>
